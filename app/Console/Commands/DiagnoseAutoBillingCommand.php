<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use App\Shared\Models\Store;
use App\Shared\Models\Subscription;
use App\Shared\Models\Invoice;
use App\Shared\Models\Plan;

class DiagnoseAutoBillingCommand extends Command
{
    protected $signature = 'billing:diagnose-auto {--store-id= : Check specific store ID} {--recent= : Show recent stores (default: 10)}';
    protected $description = 'Diagnosticar el sistema de facturaciÃ³n automÃ¡tica de tiendas';

    public function handle()
    {
        $this->info('ğŸ” DIAGNÃ“STICO DEL SISTEMA DE FACTURACIÃ“N AUTOMÃTICA');
        $this->newLine();

        if ($storeId = $this->option('store-id')) {
            $this->diagnoseSpecificStore($storeId);
        } else {
            $this->diagnoseSystemOverview();
        }
    }

    private function diagnoseSpecificStore($storeId): void
    {
        $store = Store::with(['plan', 'subscription', 'invoices'])->find($storeId);

        if (!$store) {
            $this->error("âŒ Store with ID {$storeId} not found");
            return;
        }

        $this->info("ğŸª DIAGNÃ“STICO DE TIENDA: {$store->name}");
        $this->table(['Campo', 'Valor'], [
            ['ID', $store->id],
            ['Nombre', $store->name],
            ['Slug', $store->slug],
            ['Estado', $store->status],
            ['Plan', $store->plan ? $store->plan->name : 'âŒ SIN PLAN'],
            ['Creada', $store->created_at->format('Y-m-d H:i:s')],
        ]);

        $this->newLine();

        // Verificar suscripciÃ³n
        if ($store->subscription) {
            $subscription = $store->subscription;
            $this->info("âœ… SUSCRIPCIÃ“N ENCONTRADA");
            $this->table(['Campo', 'Valor'], [
                ['ID', $subscription->id],
                ['Estado', $subscription->status],
                ['Ciclo', $subscription->billing_cycle],
                ['Inicio perÃ­odo', $subscription->current_period_start],
                ['Fin perÃ­odo', $subscription->current_period_end],
                ['PrÃ³xima facturaciÃ³n', $subscription->next_billing_date],
                ['Monto prÃ³ximo', '$' . number_format($subscription->next_billing_amount, 0, ',', '.')],
                ['Auto-creada', $subscription->metadata['auto_created_on_store_creation'] ?? 'No especificado'],
            ]);
        } else {
            $this->error("âŒ NO TIENE SUSCRIPCIÃ“N");
        }

        $this->newLine();

        // Verificar facturas
        $invoices = $store->invoices()->orderBy('created_at', 'desc')->limit(5)->get();
        if ($invoices->count() > 0) {
            $this->info("ğŸ“„ FACTURAS (Ãºltimas 5):");
            $rows = [];
            foreach ($invoices as $invoice) {
                $isFirst = $invoice->metadata['is_first_invoice'] ?? false;
                $autoGenerated = $invoice->metadata['auto_generated'] ?? false;
                
                $rows[] = [
                    $invoice->invoice_number,
                    $invoice->status,
                    '$' . number_format($invoice->amount, 0, ',', '.'),
                    $invoice->period,
                    $invoice->issue_date->format('Y-m-d'),
                    $invoice->due_date->format('Y-m-d'),
                    $isFirst ? 'ğŸ†• Primera' : ($autoGenerated ? 'ğŸ¤– Auto' : 'ğŸ‘¤ Manual')
                ];
            }
            $this->table(['NÃºmero', 'Estado', 'Monto', 'PerÃ­odo', 'EmisiÃ³n', 'Vencimiento', 'Tipo'], $rows);
        } else {
            $this->error("âŒ NO TIENE FACTURAS");
        }
    }

    private function diagnoseSystemOverview(): void
    {
        $recent = (int) $this->option('recent') ?: 10;

        // EstadÃ­sticas generales
        $totalStores = Store::count();
        $storesWithSubscription = Store::whereHas('subscription')->count();
        $storesWithInvoices = Store::whereHas('invoices')->count();
        $autoCreatedSubscriptions = Subscription::whereJsonContains('metadata->auto_created_on_store_creation', true)->count();

        $this->info("ğŸ“Š ESTADÃSTICAS GENERALES:");
        $this->table(['MÃ©trica', 'Cantidad', 'Porcentaje'], [
            ['Total de tiendas', $totalStores, '100%'],
            ['Con suscripciÃ³n', $storesWithSubscription, round(($storesWithSubscription / $totalStores) * 100, 1) . '%'],
            ['Con facturas', $storesWithInvoices, round(($storesWithInvoices / $totalStores) * 100, 1) . '%'],
            ['Suscripciones auto-creadas', $autoCreatedSubscriptions, round(($autoCreatedSubscriptions / $storesWithSubscription) * 100, 1) . '%'],
        ]);

        $this->newLine();

        // Tiendas recientes
        $recentStores = Store::with(['plan', 'subscription'])
            ->orderBy('created_at', 'desc')
            ->limit($recent)
            ->get();

        $this->info("ğŸ•’ TIENDAS RECIENTES (Ãºltimas {$recent}):");
        $rows = [];
        foreach ($recentStores as $store) {
            $hasSubscription = $store->subscription ? 'âœ…' : 'âŒ';
            $autoCreated = $store->subscription && ($store->subscription->metadata['auto_created_on_store_creation'] ?? false) ? 'ğŸ¤–' : 'ğŸ‘¤';
            $invoiceCount = $store->invoices()->count();
            
            $rows[] = [
                $store->id,
                $store->name,
                $store->plan ? $store->plan->name : 'Sin plan',
                $store->created_at->format('Y-m-d H:i'),
                $hasSubscription,
                $autoCreated,
                $invoiceCount
            ];
        }
        $this->table(['ID', 'Nombre', 'Plan', 'Creada', 'SuscripciÃ³n', 'Auto', 'Facturas'], $rows);

        $this->newLine();

        // Problemas detectados
        $this->info("ğŸš¨ PROBLEMAS DETECTADOS:");
        $storesWithoutSubscription = Store::whereDoesntHave('subscription')->count();
        $storesWithoutInvoices = Store::whereDoesntHave('invoices')->count();
        
        if ($storesWithoutSubscription > 0) {
            $this->warn("âš ï¸  {$storesWithoutSubscription} tiendas sin suscripciÃ³n");
        }
        
        if ($storesWithoutInvoices > 0) {
            $this->warn("âš ï¸  {$storesWithoutInvoices} tiendas sin facturas");
        }

        if ($storesWithoutSubscription === 0 && $storesWithoutInvoices === 0) {
            $this->info("âœ… No se detectaron problemas crÃ­ticos");
        }

        $this->newLine();
        $this->info("ğŸ’¡ Para diagnosticar una tienda especÃ­fica: php artisan billing:diagnose-auto --store-id=123");
    }
} 
document.addEventListener("alpine:init",()=>{Alpine.data("wizardStateManager",(t={})=>({wizardId:t.wizardId||"default-wizard",enableRouting:!1!==t.enableRouting,enablePersistence:!1!==t.enablePersistence,persistenceKey:t.persistenceKey||null,routePrefix:t.routePrefix||"#step-",currentRoute:"",isInitialized:!1,persistedData:{},validationStates:{},autoSaveEnabled:!1!==t.autoSaveEnabled,autoSaveInterval:t.autoSaveInterval||3e4,autoSaveTimer:null,lastServerSave:null,draftId:null,saveStatus:"idle",conflictDetected:!1,init(){this.persistenceKey||(this.persistenceKey=`wizard_${this.wizardId}_state`),this.enablePersistence&&this.loadPersistedState(),this.enableRouting&&this.setupRouting(),this.setupEventListeners(),this.autoSaveEnabled&&this.setupAutoSave(),this.checkForExistingDraft(),this.isInitialized=!0},setupRouting(){window.addEventListener("hashchange",()=>{this.handleRouteChange()}),this.handleRouteChange()},setupEventListeners(){this.$el.addEventListener("wizard:step-changed",t=>{this.handleStepChange(t.detail)}),this.$el.addEventListener("wizard:data-changed",t=>{this.handleDataChange(t.detail)}),this.$el.addEventListener("step:validated",t=>{this.handleValidationChange(t.detail)}),this.$el.addEventListener("wizard:auto-save",t=>{this.handleAutoSave(t.detail)}),this.$el.addEventListener("wizard:restore-draft",t=>{this.handleDraftRestore(t.detail)}),this.$el.addEventListener("wizard:completed",t=>{this.handleWizardCompleted(t.detail)}),this.$el.addEventListener("wizard:resolve-conflict",t=>{this.handleConflictResolution(t.detail)}),this.$el.addEventListener("wizard:clear-local-data",()=>{this.clearPersistedState()}),window.addEventListener("beforeunload",()=>{this.saveCurrentState()})},handleRouteChange(){const t=window.location.hash;if(t.startsWith(this.routePrefix)){const e=t.substring(this.routePrefix.length),a=this.parseStepFromRoute(e);null!==a&&this.canNavigateToStep(a)&&this.navigateToStepByRoute(a)}},parseStepFromRoute(t){const e=parseInt(t);if(!isNaN(e))return e;const a=this.getWizardComponent();if(a&&a.steps){const e=a.steps.findIndex(e=>e.id===t);return e>=0?e:null}return null},updateRoute(t,e=null){if(!this.enableRouting)return;const a=e||t.toString(),s=`${this.routePrefix}${a}`;window.location.hash!==s&&(this.currentRoute=s,window.history.replaceState(null,null,s))},navigateToStepByRoute(t){const e=this.getWizardComponent();e&&e.navigateToStep&&e.navigateToStep(t)},canNavigateToStep(t){const e=this.getWizardComponent();return!!e&&e.canNavigateToStep(t)},loadPersistedState(){try{const t=localStorage.getItem(this.persistenceKey);if(t){const e=JSON.parse(t);this.persistedData=e.formData||{},this.validationStates=e.validationStates||{},this.$dispatch("wizard:state-loaded",{formData:this.persistedData,validationStates:this.validationStates,timestamp:e.timestamp})}}catch(t){this.clearPersistedState()}},saveCurrentState(){if(this.enablePersistence)try{const t=this.getWizardComponent(),e=this.collectFormData(),a={wizardId:this.wizardId,currentStep:t?t.currentStep:0,formData:{...this.persistedData,...e},validationStates:this.validationStates,timestamp:(new Date).toISOString(),version:"1.0"};localStorage.setItem(this.persistenceKey,JSON.stringify(a))}catch(t){}},clearPersistedState(){try{localStorage.removeItem(this.persistenceKey),this.persistedData={},this.validationStates={}}catch(t){}},collectFormData(){const t={};return this.$el.querySelectorAll('[x-data*="wizardStep"]').forEach(e=>{const a=Alpine.$data(e);a&&a.stepId&&(t[a.stepId]=a.getData())}),t},handleStepChange(t){const{currentStep:e,stepData:a}=t;a&&this.updateRoute(e,a.id),this.saveCurrentState()},handleDataChange(t){const{stepId:e,formData:a}=t;e&&(this.persistedData[e]=a),this.debouncedSave()},handleValidationChange(t){const{stepIndex:e,stepId:a,isValid:s,errors:i}=t;this.validationStates[a||e]={isValid:s,errors:i,timestamp:(new Date).toISOString()},this.saveCurrentState()},async handleAutoSave(t){const{stepData:e,callback:a}=t;try{e.stepId&&(this.persistedData[e.stepId]=e.formData),this.saveCurrentState(),await this.saveToServer(e),a({success:!0})}catch(s){a({success:!1,error:s.message})}},async saveToServer(t){var e;try{const t=this.collectFormData(),a=this.getWizardComponent(),s={form_data:t,template:(null==a?void 0:a.selectedTemplate)||null,current_step:(null==a?void 0:a.currentStep)||1},i=await fetch("/superlinkiu/api/stores/save-draft",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":null==(e=document.querySelector('meta[name="csrf-token"]'))?void 0:e.getAttribute("content")},body:JSON.stringify(s)});if(!i.ok)throw new Error(`Server error: ${i.status}`);const r=await i.json();if(r.success)return this.lastServerSave=r.data.saved_at,this.draftId=r.data.draft_id,this.$dispatch("wizard:draft-saved",{draftId:this.draftId,savedAt:this.lastServerSave,expiresAt:r.data.expires_at}),r.data;throw new Error(r.message||"Unknown server error")}catch(a){throw this.$dispatch("wizard:draft-save-error",{error:a.message,timestamp:(new Date).toISOString()}),a}},setupAutoSave(){this.startAutoSaveTimer(),this.$el.addEventListener("input",()=>{this.scheduleAutoSave()}),this.$el.addEventListener("wizard:step-changed",()=>{this.performAutoSave()})},startAutoSaveTimer(){this.autoSaveTimer&&clearInterval(this.autoSaveTimer),this.autoSaveTimer=setInterval(()=>{this.performAutoSave()},this.autoSaveInterval)},stopAutoSaveTimer(){this.autoSaveTimer&&(clearInterval(this.autoSaveTimer),this.autoSaveTimer=null)},scheduleAutoSave(){clearTimeout(this.autoSaveDebounce),this.autoSaveDebounce=setTimeout(()=>{this.performAutoSave()},2e3)},async performAutoSave(){if("saving"!==this.saveStatus)try{this.saveStatus="saving",this.updateSaveIndicator(),this.draftId&&await this.checkForConflicts();const t=this.collectFormData();if(0===Object.keys(t).length)return void(this.saveStatus="idle");await this.saveToServer({formData:t}),this.saveStatus="saved",this.updateSaveIndicator(),setTimeout(()=>{"saved"===this.saveStatus&&(this.saveStatus="idle",this.updateSaveIndicator())},3e3)}catch(t){this.saveStatus="error",this.updateSaveIndicator(),this.showSaveError(t.message)}},async checkForConflicts(){var t;if(this.draftId&&this.lastServerSave)try{const e=await fetch("/superlinkiu/api/stores/check-draft-conflict",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":null==(t=document.querySelector('meta[name="csrf-token"]'))?void 0:t.getAttribute("content")},body:JSON.stringify({draft_id:this.draftId,last_known_update:this.lastServerSave})}),a=await e.json();a.success&&a.data.has_conflict&&(this.conflictDetected=!0,this.handleConflict(a.data))}catch(e){}},handleConflict(t){this.$dispatch("wizard:draft-conflict",{serverData:t.draft_data,serverUpdatedAt:t.server_updated_at,clientLastKnown:t.client_last_known})},async checkForExistingDraft(){var t;try{const e=await fetch("/superlinkiu/api/stores/get-draft",{method:"GET",headers:{"X-CSRF-TOKEN":null==(t=document.querySelector('meta[name="csrf-token"]'))?void 0:t.getAttribute("content")}}),a=await e.json();if(a.success&&a.data){const t=a.data;t.is_expired||(this.$dispatch("wizard:draft-found",{draftId:t.id,formData:t.form_data,template:t.template,currentStep:t.current_step,updatedAt:t.updated_at,expiresAt:t.expires_at}),this.draftId=t.id,this.lastServerSave=t.updated_at)}}catch(e){}},updateSaveIndicator(){this.$dispatch("wizard:save-status-changed",{status:this.saveStatus,lastSaved:this.lastServerSave,hasConflict:this.conflictDetected})},showSaveError(t){this.$dispatch("wizard:save-error",{message:t,timestamp:(new Date).toISOString()})},async deleteDraft(){var t;if(this.draftId)try{const e=await fetch(`/superlinkiu/api/stores/delete-draft/${this.draftId}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":null==(t=document.querySelector('meta[name="csrf-token"]'))?void 0:t.getAttribute("content")}});(await e.json()).success&&(this.draftId=null,this.lastServerSave=null,this.clearPersistedState())}catch(e){}},handleDraftRestore(t){const{formData:e,template:a,currentStep:s,draftId:i}=t;this.persistedData=e||{},this.draftId=i;const r=this.getWizardComponent();r&&(a&&(r.selectedTemplate=a),s&&r.navigateToStep(s-1)),this.$dispatch("wizard:draft-restored",{formData:this.persistedData,template:a,currentStep:s}),this.saveCurrentState()},async handleWizardCompleted(t){try{this.draftId&&await this.deleteDraft(),this.clearPersistedState(),this.stopAutoSaveTimer()}catch(e){}},handleConflictResolution(t){const{action:e}=t;switch(e){case"use-local":this.conflictDetected=!1,this.performAutoSave();break;case"use-server":this.reloadFromServer()}},async reloadFromServer(){var t;try{const e=await fetch("/superlinkiu/api/stores/get-draft",{method:"GET",headers:{"X-CSRF-TOKEN":null==(t=document.querySelector('meta[name="csrf-token"]'))?void 0:t.getAttribute("content")}}),a=await e.json();if(a.success&&a.data){const t=a.data;this.persistedData=t.form_data||{},this.lastServerSave=t.updated_at,this.conflictDetected=!1,this.$dispatch("wizard:data-reloaded",{formData:this.persistedData,template:t.template,currentStep:t.current_step})}}catch(e){}},getWizardComponent(){const t=this.$el.querySelector('[x-data*="wizardNavigation"]');return t?Alpine.$data(t):null},debouncedSave:(()=>{let t;return function(){clearTimeout(t),t=setTimeout(()=>{this.saveCurrentState()},1e3)}})(),getPersistedData(t=null){return t?this.persistedData[t]||{}:{...this.persistedData}},setPersistedData(t,e){this.persistedData[t]=e,this.saveCurrentState()},getValidationState(t){return this.validationStates[t]||null},hasPersistedData(){return Object.keys(this.persistedData).length>0},getStateInfo(){return{wizardId:this.wizardId,hasPersistedData:this.hasPersistedData(),stepCount:Object.keys(this.persistedData).length,validationStates:{...this.validationStates},lastSaved:this.getLastSavedTime()}},getLastSavedTime(){try{const t=localStorage.getItem(this.persistenceKey);if(t){return JSON.parse(t).timestamp}}catch(t){}return null},reset(){this.clearPersistedState(),this.enableRouting&&(window.location.hash="")},destroy(){this.stopAutoSaveTimer(),this.autoSaveDebounce&&clearTimeout(this.autoSaveDebounce),this.autoSaveEnabled&&this.hasPersistedData()&&this.performAutoSave()}})),Alpine.store("wizardGuards",{guards:new Map,addGuard(t,e){this.guards.set(t,e)},removeGuard(t){this.guards.delete(t)},async checkGuard(t,e){const a=this.guards.get(t);return!a||await a(e)},hasGuard(t){return this.guards.has(t)}})});

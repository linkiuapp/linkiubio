document.addEventListener("alpine:init",()=>{Alpine.data("wizardStep",(t={})=>({stepId:t.stepId||"",stepIndex:t.stepIndex||0,isOptional:t.isOptional||!1,validationRules:t.validationRules||{},autoSaveInterval:t.autoSaveInterval||3e4,formData:t.initialData||{},originalData:{},isDirty:!1,isValid:!1,isValidating:!1,validationErrors:{},isCompleted:!1,autoSaveTimer:null,lastSaveTime:null,isSaving:!1,saveStatus:"idle",init(){this.originalData=JSON.parse(JSON.stringify(this.formData)),this.setupAutoSave(),this.setupFormListeners(),this.validateStep(),this.setupWizardListeners()},destroy(){this.clearAutoSaveTimer()},setupAutoSave(){this.autoSaveInterval>0&&(this.autoSaveTimer=setInterval(()=>{this.isDirty&&!this.isSaving&&this.autoSave()},this.autoSaveInterval))},clearAutoSaveTimer(){this.autoSaveTimer&&(clearInterval(this.autoSaveTimer),this.autoSaveTimer=null)},setupFormListeners(){this.$el.addEventListener("input",t=>{t.target.matches("input, select, textarea")&&this.handleFieldChange(t.target)}),this.$el.addEventListener("change",t=>{t.target.matches("input, select, textarea")&&this.handleFieldChange(t.target)})},setupWizardListeners(){this.$el.addEventListener("wizard:validate-step",t=>{t.detail.stepIndex===this.stepIndex&&this.validateStep().then(e=>{t.detail.callback(e)})}),this.$el.addEventListener("wizard:step-changed",t=>{t.detail.currentStep===this.stepIndex?this.onStepActivated():t.detail.previousStep===this.stepIndex&&this.onStepDeactivated()})},handleFieldChange(t){const e=t.name,a=this.getFieldValue(t);this.setFieldValue(e,a),this.markDirty(),this.validateField(e,a),this.validationErrors[e]&&this.isFieldValid(e,a)&&delete this.validationErrors[e]},getFieldValue(t){switch(t.type){case"checkbox":return t.checked;case"radio":return t.checked?t.value:null;case"number":return t.value?parseFloat(t.value):null;default:return t.value}},setFieldValue(t,e){const a=t.split(".");let i=this.formData;for(let s=0;s<a.length-1;s++)i[a[s]]||(i[a[s]]={}),i=i[a[s]];i[a[a.length-1]]=e},getFieldValue(t){const e=t.split(".");let a=this.formData;for(const i of e){if(!a||"object"!=typeof a||!(i in a))return null;a=a[i]}return a},markDirty(){this.isDirty=!0,this.updateSaveStatus()},markClean(){this.isDirty=!1,this.originalData=JSON.parse(JSON.stringify(this.formData)),this.updateSaveStatus()},updateSaveStatus(){Alpine.store("autosave")&&Alpine.store("autosave").updateStatus(this.saveStatus,this.getSaveMessage())},getSaveMessage(){switch(this.saveStatus){case"saving":return"Guardando...";case"saved":return"Guardado automáticamente";case"error":return"Error al guardar";default:return""}},async validateStep(){this.isValidating=!0,this.validationErrors={};try{const t=Object.keys(this.validationRules).map(async t=>{const e=this.getFieldValue(t);return this.validateField(t,e)});if(await Promise.all(t),"function"==typeof this.customValidation){const t=await this.customValidation(this.formData);t&&t.errors&&Object.assign(this.validationErrors,t.errors)}return this.isValid=0===Object.keys(this.validationErrors).length,this.isValid&&this.markCompleted(),this.$dispatch("step:validated",{stepIndex:this.stepIndex,stepId:this.stepId,isValid:this.isValid,errors:this.validationErrors}),{isValid:this.isValid,errors:this.validationErrors}}catch(t){return this.isValid=!1,{isValid:!1,errors:{general:"Error de validación interno"}}}finally{this.isValidating=!1}},async validateField(t,e){const a=this.validationRules[t];if(!a)return!0;try{for(const i of a){const a=await this.applyValidationRule(i,e,t);if(!a.isValid)return this.validationErrors[t]=a.message,!1}return delete this.validationErrors[t],!0}catch(i){return this.validationErrors[t]="Error de validación",!1}},async applyValidationRule(t,e,a){return"string"==typeof t?this.applyBuiltInRule(t,e,a):"function"==typeof t?await t(e,a,this.formData):"object"==typeof t&&t.type?this.applyBuiltInRule(t.type,e,a,t.params):{isValid:!0}},applyBuiltInRule(t,e,a,i={}){switch(t){case"required":return{isValid:null!=e&&""!==e,message:`${a} es requerido`};case"email":return{isValid:!e||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),message:`${a} debe ser un email válido`};case"min":return{isValid:!e||e.length>=i.length,message:`${a} debe tener al menos ${i.length} caracteres`};case"max":return{isValid:!e||e.length<=i.length,message:`${a} no puede tener más de ${i.length} caracteres`};case"pattern":const t=new RegExp(i.pattern);return{isValid:!e||t.test(e),message:i.message||`${a} tiene un formato inválido`};default:return{isValid:!0}}},isFieldValid(t,e){const a=this.validationRules[t];return!a||a.every(a=>this.applyValidationRule(a,e,t).isValid)},async autoSave(){if(!this.isSaving&&this.isDirty){this.isSaving=!0,this.saveStatus="saving",this.updateSaveStatus();try{const t={stepId:this.stepId,stepIndex:this.stepIndex,formData:this.formData,timestamp:(new Date).toISOString()},e=await new Promise(e=>{this.$dispatch("wizard:auto-save",{stepData:t,callback:e}),setTimeout(()=>e({success:!0}),1e4)});if(!e.success)throw new Error(e.error||"Save failed");this.lastSaveTime=new Date,this.saveStatus="saved",this.markClean(),setTimeout(()=>{"saved"===this.saveStatus&&(this.saveStatus="idle",this.updateSaveStatus())},3e3)}catch(t){this.saveStatus="error",setTimeout(()=>{"error"===this.saveStatus&&(this.saveStatus="idle",this.updateSaveStatus())},5e3)}finally{this.isSaving=!1,this.updateSaveStatus()}}},onStepActivated(){const t=this.$el.querySelector("input, select, textarea");t&&t.focus()},onStepDeactivated(){this.isDirty&&this.autoSave()},markCompleted(){this.isCompleted||(this.isCompleted=!0,this.$dispatch("step:completed",{stepIndex:this.stepIndex,stepId:this.stepId,formData:this.formData}))},reset(){this.formData=JSON.parse(JSON.stringify(this.originalData)),this.validationErrors={},this.isValid=!1,this.isCompleted=!1,this.isDirty=!1,this.saveStatus="idle",this.updateSaveStatus()},getData(){return JSON.parse(JSON.stringify(this.formData))},setData(t){this.formData={...this.formData,...t},this.markDirty()},getErrors(){return{...this.validationErrors}},clearErrors(){this.validationErrors={}},hasErrors(){return Object.keys(this.validationErrors).length>0},forceSave(){return this.autoSave()}})),Alpine.store("autosave",{isVisible:!1,status:"idle",message:"",updateStatus(t,e){this.status=t,this.message=e,this.isVisible="idle"!==t}})});

class t{constructor(){if(this.items=[],this.isValidContext())try{this.initializeEvents(),this.syncWithServer()}catch(t){}}isValidContext(){const t=null!==document.querySelector('meta[name="csrf-token"]'),e=!window.location.pathname.includes("/admin")&&!window.location.pathname.includes("/superlinkiu");return t&&e}loadCart(){return this.items}saveCart(){this.updateCartDisplay()}async addProduct(t){try{const e=await fetch(this.getCartAddUrl(),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({product_id:t.id,quantity:1,variants:t.variants||null})}),r=await e.json();r.success?(this.updateProductBadge(t.id,r.cart),this.showAddedFeedback(t.name),this.updateCartDisplayFromServer(r)):this.showError(r.message||"Error al agregar producto")}catch(e){const t=!navigator.onLine||"NetworkError"===e.name||e.message.includes("fetch");this.showError("Error al agregar producto",t)}}async removeProduct(t){try{const e=await fetch(this.getCartRemoveUrl(),{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({item_key:t})}),r=await e.json();r.success?this.updateCartDisplayFromServer(r):this.showError(r.message||"Error al eliminar producto")}catch(e){const t=!navigator.onLine||"NetworkError"===e.name||e.message.includes("fetch");this.showError("Error al eliminar producto",t)}}async updateQuantity(t,e){if(e<=0)this.removeProduct(t);else try{const r=await fetch(this.getCartUpdateUrl(),{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({item_key:t,quantity:e})}),a=await r.json();a.success?this.updateCartDisplayFromServer(a):this.showError(a.message||"Error al actualizar cantidad")}catch(r){const t=!navigator.onLine||"NetworkError"===r.name||r.message.includes("fetch");this.showError("Error al actualizar cantidad",t)}}async clearCart(){try{const t=await fetch(this.getCartClearUrl(),{method:"DELETE",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}}),e=await t.json();e.success?this.updateCartDisplayFromServer(e):this.showError(e.message||"Error al vaciar carrito")}catch(t){const e=!navigator.onLine||"NetworkError"===t.name||t.message.includes("fetch");this.showError("Error al vaciar carrito",e)}}getTotalItems(){const t=document.querySelector(".cart-badge");return t&&parseInt(t.textContent)||0}getTotalPrice(){const t=document.querySelector(".cart-total-price");if(t){const e=t.textContent.replace(/[^\d]/g,"");return parseInt(e)||0}return 0}updateCartDisplay(){const t=document.getElementById("cart-float");if(!t)return;const e=this.getTotalItems(),r=this.getTotalPrice(),a=t.querySelector(".cart-badge");a&&(a.textContent=e,a.style.display=e>0?"flex":"none");const o=t.querySelector(".cart-count-text");o&&(o.textContent=1===e?"1 producto":`${e} productos`);const n=t.querySelector(".cart-total-price");n&&(n.textContent=`$${this.formatPrice(r)}`),t.classList.remove("hidden")}formatPrice(t){return new Intl.NumberFormat("es-CO",{minimumFractionDigits:0,maximumFractionDigits:0}).format(t)}async syncWithServer(){try{const t=await fetch(this.getCartGetUrl()),e=await t.json();e.success?(this.updateCartDisplayFromServer(e),this.updateAllProductBadges(e.cart)):(this.updateCartDisplayFromServer({cart_count:0,formatted_cart_total:"$0"}),this.hideAllProductBadges())}catch(t){this.updateCartDisplayFromServer({cart_count:0,formatted_cart_total:"$0"}),this.hideAllProductBadges()}}getCartAddUrl(){const t=window.location.pathname.split("/").filter(t=>t)[0]||"";if(!t)throw new Error("No se pudo determinar el slug de la tienda");return`/${t}/carrito/agregar`}getCartGetUrl(){const t=window.location.pathname.split("/").filter(t=>t)[0]||"";if(!t)throw new Error("No se pudo determinar el slug de la tienda");return`/${t}/carrito/contenido`}getCartUpdateUrl(){const t=window.location.pathname.split("/").filter(t=>t)[0]||"";if(!t)throw new Error("No se pudo determinar el slug de la tienda");return`/${t}/carrito/actualizar`}getCartRemoveUrl(){const t=window.location.pathname.split("/").filter(t=>t)[0]||"";if(!t)throw new Error("No se pudo determinar el slug de la tienda");return`/${t}/carrito/eliminar`}getCartClearUrl(){const t=window.location.pathname.split("/").filter(t=>t)[0]||"";if(!t)throw new Error("No se pudo determinar el slug de la tienda");return`/${t}/carrito/limpiar`}updateCartDisplayFromServer(t){const e=document.getElementById("cart-float");if(!e)return;const r=e.querySelector(".cart-badge");r&&(r.textContent=t.cart_count||0,r.style.display=t.cart_count>0?"flex":"none");const a=e.querySelector(".cart-count-text");if(a){const e=t.cart_count||0;a.textContent=1===e?"1 producto":`${e} productos`}const o=e.querySelector(".cart-total-price");o&&(o.textContent=t.formatted_cart_total||"$0"),t.cart?this.updateAllProductBadges(t.cart):this.hideAllProductBadges(),e.classList.remove("hidden")}showAddedFeedback(t){const e=document.querySelector(".cart-badge"),r=document.querySelector(".cart-total-price"),a=e?e.textContent:"0",o=r?r.textContent:"$0",n=document.createElement("div");n.className="fixed top-6 left-1/2 transform -translate-x-1/2 bg-success-300 px-6 py-4 rounded-2xl shadow-2xl z-[9999] transition-all duration-300 -translate-y-32 opacity-0",n.innerHTML=`\n            <div class="flex items-center gap-4">\n                <div class="flex-shrink-0">\n                    <svg class="w-10 h-10 text-black-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                    </svg>\n                </div>\n \n                <div class="flex flex-col gap-1">\n                    <span class="text-body-regular font-bold text-black-500">Producto agregado</span>\n                    <span class="text-body-small font-medium text-black-500">\n                        ${a} en carrito · ${o}\n                    </span>\n                </div>\n            </div>\n        `,document.body.appendChild(n),setTimeout(()=>{n.classList.remove("-translate-y-32","opacity-0")},100),setTimeout(()=>{n.classList.add("-translate-y-32","opacity-0"),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},300)},2500)}showError(t,e=!1){const r=document.querySelector(".cart-error-notification");r&&r.remove();let a=t,o="M6 18L18 6M6 6l12 12";e?(a="Sin conexión. Verifica tu internet e intenta nuevamente.",o="M18.364 5.636l-12.728 12.728"):t.includes("404")?(a="Producto no encontrado. La página será actualizada.",setTimeout(()=>window.location.reload(),2e3)):t.includes("500")?a="Error del servidor. Intenta nuevamente en unos momentos.":t.includes("no disponible")&&(a="Producto agotado o no disponible.");const n=document.createElement("div");n.className="cart-error-notification fixed top-4 right-4 bg-error-300 text-accent-50 px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full max-w-sm",n.innerHTML=`\n            <div class="flex items-start gap-2">\n                <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${o}"></path>\n                </svg>\n                <div class="flex-1">\n                    <span class="text-sm font-medium block">${a}</span>\n                    ${e?'<span class="text-xs opacity-75 block mt-1">Se reintentará automáticamente</span>':""}\n                </div>\n                <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-accent-50 hover:text-accent-200">\n                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n                    </svg>\n                </button>\n            </div>\n        `,document.body.appendChild(n),setTimeout(()=>{n.classList.remove("translate-x-full")},100);setTimeout(()=>{n.parentNode&&(n.classList.add("translate-x-full"),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},300))},e?5e3:4e3)}updateProductBadge(t,e){const r=document.querySelector(`[data-product-badge="${t}"]`);if(!r)return;const a=this.getProductQuantityInCart(t,e);a>0?(r.textContent=a,r.style.display="flex",r.classList.remove("hidden"),r.classList.add("animate-bounce"),setTimeout(()=>r.classList.remove("animate-bounce"),500)):(r.style.display="none",r.classList.add("hidden"))}updateAllProductBadges(t){if(!t||!t.items)return void this.hideAllProductBadges();document.querySelectorAll("[data-product-badge]").forEach(e=>{const r=e.dataset.productBadge,a=this.getProductQuantityInCart(r,t);a>0?(e.textContent=a,e.style.display="flex",e.classList.remove("hidden")):(e.style.display="none",e.classList.add("hidden"))})}hideAllProductBadges(){document.querySelectorAll("[data-product-badge]").forEach(t=>{t.style.display="none",t.classList.add("hidden")})}getProductQuantityInCart(t,e){if(!e||!e.items)return 0;let r=0;return e.items.forEach(e=>{(e.product_id||e.variant&&e.variant.product_id)==t&&(r+=e.quantity||1)}),r}initializeEvents(){document.addEventListener("click",t=>{const e=t.target.closest(".add-to-cart-btn");if(e){t.preventDefault(),t.stopPropagation();const r={id:parseInt(e.dataset.productId),name:e.dataset.productName,price:parseFloat(e.dataset.productPrice),image:e.dataset.productImage||null};this.addProduct(r)}},!0),document.addEventListener("click",t=>{t.target.closest(".view-cart-btn")&&(t.preventDefault(),window.location.href=t.target.closest(".view-cart-btn").href)})}}function e(){const e=!window.location.pathname.includes("/admin")&&!window.location.pathname.includes("/superlinkiu")&&"/"!==window.location.pathname&&"/login"!==window.location.pathname&&"/register"!==window.location.pathname;if(document.querySelector('meta[name="csrf-token"]'),e)try{window.cart=new t}catch(r){}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e(),window.addToCart=function(t,e,r,a){if(window.cart&&"function"==typeof window.cart.addProduct)try{window.cart.addProduct({id:t,name:e,price:r,image:a})}catch(o){}},window.removeFromCart=function(t){if(window.cart&&"function"==typeof window.cart.removeProduct)try{window.cart.removeProduct(t)}catch(e){}},window.updateCartQuantity=function(t,e){if(window.cart&&"function"==typeof window.cart.updateQuantity)try{window.cart.updateQuantity(t,e)}catch(r){}},window.clearCart=function(){if(window.cart&&"function"==typeof window.cart.clearCart)try{window.cart.clearCart()}catch(t){}};
